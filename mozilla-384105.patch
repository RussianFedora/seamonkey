---
 layout/xul/base/src/nsMenuFrame.cpp |   53 +++++++++++++++++++++++++++++++++---
 1 file changed, 49 insertions(+), 4 deletions(-)

Index: mozilla/layout/xul/base/src/nsMenuFrame.cpp
===================================================================
--- mozilla.orig/layout/xul/base/src/nsMenuFrame.cpp	2007-10-09 18:25:33.000000000 +0200
+++ mozilla/layout/xul/base/src/nsMenuFrame.cpp	2007-10-09 18:25:54.000000000 +0200
@@ -694,27 +694,72 @@
     if (genVal.IsEmpty()) {
       child->SetAttr(kNameSpaceID_None, nsXULAtoms::menugenerated, NS_LITERAL_STRING("true"), PR_TRUE);
     }
   }
 
   return NS_OK;
 }
 
+struct nsASyncUngenerate : public PLEvent
+{
+  nsASyncUngenerate(nsIContent* aContent)
+    : mContent(aContent)
+  {
+  }
+
+  void HandleEvent() {
+    nsAutoString genVal;
+    mContent->GetAttr(kNameSpaceID_None, nsXULAtoms::menugenerated, genVal);
+    if (!genVal.IsEmpty()) {
+      mContent->UnsetAttr(kNameSpaceID_None, nsXULAtoms::menugenerated,
+                          PR_TRUE);
+    }
+  }
+
+  nsCOMPtr<nsIContent> mContent;
+};
+
+static void* PR_CALLBACK HandleASyncUngenerate(PLEvent* aEvent)
+{
+  NS_STATIC_CAST(nsASyncUngenerate*, aEvent)->HandleEvent();
+  return nsnull;
+}
+
+static void PR_CALLBACK DestroyASyncUngenerate(PLEvent* aEvent)
+{
+  delete NS_STATIC_CAST(nsASyncUngenerate*, aEvent);
+}
+
 NS_IMETHODIMP
 nsMenuFrame::UngenerateMenu()
 {
   nsCOMPtr<nsIContent> child;
   GetMenuChildrenElement(getter_AddRefs(child));
   
   if (child) {
-    nsAutoString genVal;
-    child->GetAttr(kNameSpaceID_None, nsXULAtoms::menugenerated, genVal);
-    if (!genVal.IsEmpty())
-      child->UnsetAttr(kNameSpaceID_None, nsXULAtoms::menugenerated, PR_TRUE);
+    nsCOMPtr<nsIEventQueueService> eventService =
+      do_GetService(kEventQueueServiceCID);
+    if (eventService) {
+      nsCOMPtr<nsIEventQueue> eventQueue;
+        eventService->GetThreadEventQueue(PR_GetCurrentThread(),
+                                          getter_AddRefs(eventQueue));
+      if (eventQueue) {
+        nsASyncUngenerate* ungenerate =
+          new nsASyncUngenerate(child);
+        if (ungenerate) {
+          PL_InitEvent(ungenerate, nsnull,
+                       ::HandleASyncUngenerate,
+                       ::DestroyASyncUngenerate);
+          if (NS_FAILED(eventQueue->PostEvent(ungenerate))) {
+            PL_DestroyEvent(ungenerate);
+          }
+        }
+      }
+    }
   }
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsMenuFrame::ActivateMenu(PRBool aActivateFlag)
 {
